<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (c) 2003-2018 Broad Institute, Inc., Massachusetts Institute of Technology, and Regents of the University of California.  All rights reserved.
-->

<project basedir="" default="devReleaseModule" name="GSEA">
    <property name="main-class" value="org.genepattern.modules.gsea.GseaWrapper" />
    <path id="library.classpath">
        <fileset dir="lib" id="module.lib" includes="*.jar" />
    </path>
    <property name="class-path" value="log4j-core-2.11.0.jar batik-codec-1.10.jar commons-cli-1.2.jar commons-io-2.4.jar commons-lang3-3.4.jar disable-prefs.jar gsea-snapshot.jar" />
    <pathconvert property="class-path" pathsep=" " refid="library.classpath">
        <flattenmapper />
    </pathconvert>

    <target name="init">
        <tstamp />
        <property name="test.version" value="999999999"/>
        <property name="dest.dir" value="build" />

        <mkdir dir="build" />
        <property name="appfile" value="${ant.project.name}_gp.jar" />
        <property name="inclds" value="org/genepattern/modules/gsea/*.java" />
        <property name="java.target" value="1.8" />
    </target>

    <target name="init_devrelease" depends="init">
    	<!-- Set the full.version property so that it doesn't come in from release.properties -->
        <property name="full.version" value="DEV_BUILD" />    	
        <property name="prereleasingModule" value="false" />
        <property name="quality.level" value="development" />
    </target>

    <!-- Bump the build number and set the quality flag if we're doing a prerelease or release -->
    <target name="init_prerelease" depends="init">
        <property name="prereleasingModule" value="true" />
        <property name="quality.level" value="preproduction" />
    </target>

    <target name="init_release" depends="init">
        <property name="prereleasingModule" value="false" />
        <property name="quality.level" value="production" />
    </target>

    <target name="package" depends="init, clean, compile">
        <jar basedir="build" defaultexcludes="true" includes="org/**" jarfile="${appfile}">
            <manifest>
                <attribute name="Main-Class" value="${main-class}" />
                <attribute name="Class-Path" value="${class-path}" />
            </manifest>
        </jar>
    </target>

    <target name="clean">
        <delete>
            <fileset dir="build" includes="org/**" />
        </delete>
    </target>

    <target name="compile" depends="init">
        <javac debug="true" defaultexcludes="true" deprecation="true" destdir="build" includes="${inclds}" optimize="false" proceed="false" srcdir="src" target="${java.target}" source="${java.target}">
            <classpath refid="library.classpath" />
        </javac>
    </target>

    <target name="update-release-props" depends="init">
        <!-- Increment the build number for use in the LSID & version-->
        <propertyfile file="release.properties">
          <entry key="build.number" type="int" operation="+" default="1" />
          <entry key="build.timestamp" type="date" operation="=" value="${time.stamp}" pattern="EEE, d MMM yyyy HH:mm:ss Z" />
        </propertyfile>
    </target>

    <target name="load-release-props">
      <property file="release.properties" />
    </target>

    <target name="create-zip" depends="addLSIDtoManifest,package">
        <zip destfile="${dest.dir}/${ant.project.name}_v${full.version}.zip" whenempty="fail" defaultexcludes="true">
            <fileset dir="." includes="manifest, *.html, *.json, LICENSE.txt, LICENSE-3RD-PARTY.txt, release.properties, ${appfile}" />
            <fileset dir="lib" includes="*.jar" />
        </zip>
    </target>

    <target name="devReleaseModule" depends="init_devrelease,load-release-props,create-zip,resetManifest" />

    <target name="prereleaseModule" depends="init_prerelease,update-release-props,load-release-props,create-zip,resetManifest" />
    
    <target name="releaseModule" depends="init_release,update-release-props,load-release-props,create-zip,resetManifest" />
    
    <target name="addLSIDtoManifest" depends="init,getLSID">
        <tstamp>
            <format property="publish.time" pattern="MM/dd/yyyy HH:mm " />
        </tstamp>

        <!-- Work on a copy of the manifest to avoid unnecessary churn in version control. -->
        <copy file="manifest" tofile="manifest.tmp" preservelastmodified="true" overwrite="true" />

        <!-- NOTE: this will overwrite any LSID already in the manifest file -->
        <propertyfile file="manifest">
            <entry key="quality" value="${quality.level}" />
            <entry key="LSID" value="${LSID}" />
            <entry key="publicationDate" value="${publish.time}" />
        </propertyfile>
    </target>

    <target name="getLSID">
        <property name="LSID.key" value="${ant.project.name}.lsid" />
        <condition property="full.version" value="${release.version}.${build.number}" else="DEV_BUILD">
            <isset property="release.version" />
        </condition>
        <condition property="LSID" value="${LSID.noVersion}:${full.version}" else="${LSID.noVersion}:${test.version}">
            <not><equals arg1="${full.version}" arg2="DEV_BUILD" /></not>
        </condition>
        <echo>${LSID.key} = ${LSID}</echo>
    </target>

    <target name="resetManifest">
        <move file="manifest.tmp" tofile="manifest" preservelastmodified="true" overwrite="true" failonerror="true" />
    </target>
</project>
